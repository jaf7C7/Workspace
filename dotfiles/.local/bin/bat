#!/bin/sh
#
# `bat`: Battery monitor.
#
# Depends: `cat`, `tmux`/`screen`
# Environment: SCREENDIR, BAT_DIR
#
# Return values:
#   - 0 (No action required)
#   - 1 (Low battery)
#   - 2 (Battery charging while full)
#   - 3 (Status unknown)
#   - 4 (Other error)

: "${SCREENDIR:=/run/screen/S-joss}"
: "${BAT_DIR:=/sys/class/power_supply/BAT1}"

usage () {
	echo 'usage: bat [-q|--quiet] [-m|--monitor]'
} >&2

check_status () {
	capacity="$(cat "$BAT_DIR/capacity")"
	status="$(cat "$BAT_DIR/status")"
	msg="$capacity%"

	case "$status" in
		Discharging) [ "$capacity" -lt 30 ] && return 1 ;;
		Charging) msg="~${msg}"; [ "$capacity" -gt 70 ] && return 2 ;;
		*) return 3 ;;
	esac

	return 0
}

only_session () {
	# shellcheck disable=SC2046
	set -- $(tmux ls -F '#{session_id}')
	total_sessions=$#

	set -- "$SCREENDIR"/*
	case "$*" in
		*[!*]) total_sessions=$((total_sessions + $#))
	esac

	[ "$total_sessions" -gt 1 ] && return 1
	return 0
}

# Tmux doesn't allow duplicate sessions but screen does.
remove_dups () {
	screen -qlsS battery_monitor
	[ $? -le 11 ] && return

	set -- "$SCREENDIR"/*battery_monitor
	for session do
		session="${session##*/}"

		screen -qlsS "$session"
		[ $? -eq 11 ] || continue

		if [ -n "$survivor" ]; then
			screen -S "$session" -X quit
		else
			survivor="$session"
		fi
	done
}

notify () {
	for session in $(tmux ls -F '#{session_id}' 2>/dev/null); do
		for client in $(tmux lsc -t "$session" -F '#{client_name}'); do
			tmux display -c "$client" "$1"
		done
	done

	for session in "$SCREENDIR"/*; do
		session="${session##*/}"
		case "$(screen -lsS "$session")" in
			*Attached*) screen -S "$session" -X echo "$1"
		esac
	done

	[ -z "${TMUX}${STY}" ] && printf '%s\n' "$1"
}

main ()
{
	quiet=0
	monitor=0
	debug=0
	while [ $# -gt 0 ]; do
		case "$1" in
			-q|--quiet)   quiet=1 ;;
			-m|--monitor) monitor=1 ;;
			-d|--debug)   debug=1 ;;
			-h|--help|*)  usage ;;
		esac
		shift
	done

	if [ "$quiet" -eq 1 ]; then
		check_status
		return
	fi

	if [ "$monitor" -eq 1 ]; then
		if [ "$debug" -eq 1 ]; then
			logfile=/tmp/bat.log
			exec 2>"$logfile"
			set -x
		fi

		while check_status; return=$?; do
			if only_session; then
				[ -e "$logfile" ] && rm "$logfile"
				return 0
			else
				remove_dups
			fi

			case "$return" in
				3) notify "Check battery: $msg" ;;
				2) notify "Battery full: $msg" ;;
				1) notify "Low battery: $msg" ;;
			esac

			sleep 30
		done

		return 4
	fi

	check_status
	return=$?
	printf '%s\n' "$msg"
	return "$return"
}

main "$@"
