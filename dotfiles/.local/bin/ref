#!/bin/sh
#
# Search bookmark and local documents.

: "${BOOKMARKS:="$ZETTELKAST/222205121754.md"}"
: "${DOCUMENTS:="$HOME/Documents"}"

usage () {
	echo 'usage: ref [<option>] <keyword>'
	echo 'without option: display results for <keyword> in BROWSER'
	echo 'options: -m  print results as markdown links to stdout'
	echo '         -n  print file paths/urls to stdout'
	echo '         -h  display this message'
	exit
}

search () {
	for arg do 
		regex="${regex+"$regex.*"}$arg"
		glob="${glob+"$glob*"}$arg"
	done

	grep -i "$regex" "$BOOKMARKS" | while IFS= read -r result; do
		if [ -n "$nobrowser" ] && [ -z "$markdown" ]; then
			result="${result##*(}"
			result="${result%)*}"
		elif [ -n "$markdown" ]; then
			result="${result#\* }"
		fi

		printf '%s\n' "$result"
	done

	for result in "$DOCUMENTS"/*"$glob"*; do
		[ -e "$result" ] || continue

		if [ -n "$markdown" ]; then
			result="$(linkify "$result")"
		elif [ -z "$nobrowser" ]; then
			result="* $(linkify "$result")"
		fi

		printf '%s\n' "$result"
	done

	if [ -n "$markdown" ]; then
		zet -lS "$@"
	else
		zet -S "$@"
	fi | while IFS= read -r result; do
		case "$result" in
			*222205121754*) continue
		esac

		if [ -z "$nobrowser" ]; then
			result="* $(linkify "$result")"
		fi

		printf '%s\n' "$result"
	done
}

main()
{
	tmp=/tmp/ref-$$.html

	while getopts :hmn opt; do
		case "$opt" in
			m) markdown=1 nobrowser=1 ;;
			n) nobrowser=1 ;;
			h) usage ;;
			*) ! usage ;;
		esac

		shift $((OPTIND - 1))
	done

	if [ -n "$nobrowser" ]; then
		search "$@"
	else
		search "$@" | pandoc -f markdown+smart -t html -o "$tmp"
		exec "$BROWSER" "$tmp"
	fi
}

main "$@"

