#!/bin/sh
#
# `linkify`: Create markdown links to filenames.
#
# Depends: `fullpath`/`realpath`
# Environment: ZETTELKAST

: "${ZETTELKAST:=$HOME/Zettelkast}"

error () {
	echo "linkify: $*"
	exit 1
} >&2

main ()
{
	case "$1" in
		-z)
			shift
			zet=1
		;;
	esac

	if [ $# -eq 0 ]; then
		while read -r file; do
			set -- "$@" "$file"
		done
	fi

	for file do
		if command -v fullpath >/dev/null 2>&1; then
			file="$(fullpath "$file")"
		else
			file="$(realpath "$file")"
		fi

		[ -e "$file" ] || error "$file not found"

		case "$file" in
			"$ZETTELKAST"/*.md)
				id="${file##*/}" id="${id%.md}"
				IFS= read -r title <"$file"
				id="$id(${title#\# })"

				# 'zet:' urls must not contain '/', only the
				# zet ID.
				file="${file##*/}"
			;;
			~/*) id="${file##*/}" ;;
			*) id="$file" ;;
		esac

		scheme='file'
		[ -n "$zet" ] && scheme='zet'

		printf '[%s](%s:%s)\n' "$id" "$scheme" "$file"
	done
}

main "$@"

