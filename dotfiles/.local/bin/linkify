#!/bin/sh
#
# Create markdown links to filenames.

: "${ZETTELKAST:=$HOME/Zettelkast}"

error () {
	msg="$1"
	printf '%s: %s\n' "${0##*/}" "$msg"
	unset msg
	exit 1
} >&2

main ()
{
	case "$1" in
		-z)
			shift
			ztp=1
		;;
	esac

	if [ $# -eq 0 ]; then
		while read -r file; do
			set -- "$@" "$file"
		done
	fi

	for file do
		file="$(fullpath "$file")"
		[ -e "$file" ] || error "$file not found"

		case "$file" in
			"$ZETTELKAST"/*.md)
				id="${file##*/}" id="${id%.md}"
				IFS= read -r title <"$file"
				id="$id(${title#\# })"
			;;
			~/*) id="${file##*/}" ;;
			*) id="$file" ;;
		esac

		scheme='file'
		[ -n "$ztp" ] && scheme='ztp'

		printf '[%s](%s:%s)\n' "$id" "$scheme" "$file"
	done
}

main "$@"

